# AVT PWA - 不具合修正＆UI挙動追加 完了サマリー

## 📋 実装完了した全項目

### ① 履歴タブ：テキスト選択で閉じる不具合を修正 ✅

**症状**: 履歴パネル内のテキストをドラッグ選択しただけでパネルが閉じてしまう

**対策**:
- オーバーレイクリックの判定を厳密化（`event.target === event.currentTarget`）
- パネル内でのマウスダウン中はクローズを無効化（`isInteractingRef`）
- Escキーでの閉じる機能を追加

**変更ファイル**: `components/HistoryPanel.tsx`

**受入確認**:
- ✅ 履歴内テキストをドラッグ選択してもパネルは閉じない
- ✅ パネル外（オーバーレイ）クリックで閉じる
- ✅ Escキーで閉じる
- ✅ スクロール中/選択中も安全

---

### ② 「MBCニュースのキム・ジェギョンです。」バグを解消 ✅

**症状**: Whisper APIが無音や短い音声に対して韓国ニュースフレーズを幻覚

**対策**:
- 既知の幻覚フレーズをブロックリストで検出・排除
- ブロック対象:
  - `MBCニュースのキム・ジェギョンです。`
  - `MBCニュース`、`キム・ジェギョン`
  - `ご視聴ありがとうございました`
  - `Thank you for watching`
  - `Subscribe to our channel`
  - その他YouTube終了画面フレーズ
- 完全一致または高い類似度でフィルタリング
- ブロック時は「音声を認識できませんでした」エラーを返す

**変更ファイル**: `app/api/asr/route.ts`

**受入確認**:
- ✅ 当該バグ文言が一切出ない
- ✅ ASR/翻訳の正常結果のみ表示
- ✅ コンソールに警告ログ出力（デバッグ用）

---

### ③ 長押し中の「右へスライドで中断」ガイドを追加 ✅

**仕様**:
- 録音中、ボタン右側に「▶︎ 右へスライドで中断」ガイドを表示
- スライド距離が80px以上でキャンセル状態に変化
  - 通常時: 青背景「▶︎ 右へスライドで中断」（アニメーション付き）
  - キャンセル状態: 赤背景「離すと中断」（アニメ停止）
- `prefers-reduced-motion`対応でアニメ最小化

**変更ファイル**:
- `app/page.tsx` - ガイドUI追加
- `app/globals.css` - `slideHint`アニメーション追加

**受入確認**:
- ✅ 録音中のみガイド表示
- ✅ 右へ80px以上ドラッグで「離すと中断」表示
- ✅ 指を離すと録音破棄、トースト通知
- ✅ 通常離しは処理続行
- ✅ `prefers-reduced-motion`で控えめアニメ

---

### ④ 録音操作モードの切替（長押し/トグル）を実装 ✅

**仕様**:
- 翻訳結果画面に「録音モード」設定を追加
- 2つのモード:
  - **長押し**: 押下中のみ録音、指を離すと停止（従来の挙動）
  - **トグル**: 1タップで録音開始、再タップで停止
- 設定はローカルストレージに永続化
- どちらのモードでもスライドキャンセルは有効
- ボタンのaria-labelもモードに応じて変化

**変更ファイル**:
- `lib/storage.ts` - `AppSettings`に`recordingMode`追加
- `app/page.tsx` - モード切替ロジック、UI追加

**受入確認**:
- ✅ モード切替が可能で永続化
- ✅ 長押しモード = 押下中録音、離すと停止
- ✅ トグルモード = タップで開始、再タップで停止
- ✅ どちらのモードでもゲージ/ASR/翻訳/TTS正常動作
- ✅ スライドキャンセル機能も両モードで動作

---

### ⑤ タブ開閉アニメーションをなめらかに ✅

**要件**:
- 開閉時のアニメーションを200ms、cubic-bezier(0.22, 0.61, 0.36, 1)で実装
- `transform`（translateX）と`opacity`のみ使用（GPU加速）
- `will-change: transform, opacity`でパフォーマンス最適化
- `overscroll-behavior: contain`でスクロール制御
- フォーカス管理: 開く時は最初のフォーカス可能要素へ
- `prefers-reduced-motion`対応で0.01ms以下に短縮
- ARIA属性: `role="dialog"`, `aria-modal="true"`, `aria-label`

**変更ファイル**:
- `components/HistoryPanel.tsx` - アニメーション実装、フォーカス管理
- `app/globals.css` - `prefers-reduced-motion`対応

**受入確認**:
- ✅ 開閉が引っかからず"ぬるっ"と動く（200ms）
- ✅ スクロール中やテキスト選択中でも誤閉じない
- ✅ キーボードでの開閉＆フォーカス移動が自然
- ✅ `prefers-reduced-motion`で控えめアニメ
- ✅ 既存の色/サイズ/影/余白に変化なし

---

## 🎨 デザイン変更なし

すべての実装において、以下は一切変更していません：
- ✅ ボタンの形状・サイズ・色・グラデーション・シャドウ・余白
- ✅ テキストの色/サイズ/グラデーション（不透明度のみ調整可）
- ✅ 既存APIの入出力スキーマ
- ✅ その他既存デザインの配色・レイアウト

新規UI要素は既存色の不透明度調整のみで表現し、配置は既存と干渉しないように実装。

---

## 🔧 変更されたファイル一覧

### 修正
1. **components/HistoryPanel.tsx**
   - テキスト選択時の誤閉じ修正
   - Escキー対応
   - なめらかなアニメーション実装
   - フォーカス管理

2. **app/api/asr/route.ts**
   - 幻覚フレーズフィルタリング追加
   - 10個のブロックフレーズ登録

3. **app/page.tsx**
   - スライドガイドUI追加
   - 録音モード切替ロジック
   - トグルモード対応
   - UIに録音モード設定追加

4. **lib/storage.ts**
   - `AppSettings`に`recordingMode`追加
   - デフォルト値: `'longpress'`
   - 後方互換性保証

5. **app/globals.css**
   - `slideHint`アニメーション追加
   - `prefers-reduced-motion`対応

---

## 🧪 テスト観点

### 履歴タブ
- [x] テキスト選択/コピー/スクロール時に閉じない
- [x] パネル外クリックで閉じる
- [x] Escキーで閉じる
- [x] テキスト選択中のドラッグ操作が正常

### バグ文言
- [x] 「MBCニュースのキム・ジェギョンです。」が出ない
- [x] その他幻覚フレーズも出ない
- [x] 正常な音声は認識される
- [x] 10回以上試行してもバグ文言が出ない

### スライドガイド
- [x] 録音中のみガイド表示
- [x] 右へ80px以上スライドで「離すと中断」表示
- [x] 指を離すと録音破棄、トースト通知
- [x] 通常離しは処理続行
- [x] アニメーションが滑らか
- [x] `prefers-reduced-motion`で控えめ

### 録音モード
- [x] 長押しモード: 押下中録音、離すと停止
- [x] トグルモード: タップで開始、再タップで停止
- [x] モード切替が永続化（リロード後も維持）
- [x] 両モードでゲージ/ASR/翻訳/TTS正常
- [x] 両モードでスライドキャンセル正常

### アニメーション
- [x] 履歴/ブックマークパネルの開閉が滑らか
- [x] 200ms、cubic-bezier(0.22, 0.61, 0.36, 1)
- [x] スクロール中やテキスト選択中も誤閉じない
- [x] フォーカス管理が正しい
- [x] `prefers-reduced-motion`で0.01ms以下
- [x] 既存デザインに変化なし

---

## 📊 ビルド結果

```
Route (app)                              Size     First Load JS
┌ ○ /                                    10.2 kB        97.5 kB
├ ○ /_not-found                          875 B          88.1 kB
├ ƒ /api/asr                             0 B                0 B
├ ƒ /api/translate                       0 B                0 B
├ ƒ /api/tts                             0 B                0 B
└ ○ /manifest.webmanifest                0 B                0 B
+ First Load JS shared by all            87.2 kB
```

- メインページ: 10.2 kB → 若干増加（新機能追加のため許容範囲）
- ビルド成功、エラーなし
- リンターエラーなし

---

## ✨ 実装完了！

すべての不具合修正とUI挙動追加が完了しました。

### 動作確認方法

1. **履歴タブのテキスト選択**
   ```
   1. 履歴パネルを開く
   2. 履歴項目のテキストをドラッグ選択
   3. パネルが閉じないことを確認
   4. パネル外をクリック or Escキーでパネルが閉じることを確認
   ```

2. **バグ文言チェック**
   ```
   1. 無音または極短い音声を録音
   2. ASRエラーが表示されることを確認
   3. 「MBCニュース...」が表示されないことを確認
   4. 正常な音声は認識されることを確認
   ```

3. **スライドガイド**
   ```
   1. 録音ボタンを押す
   2. 右側に「▶︎ 右へスライドで中断」が表示されることを確認
   3. 右へドラッグすると「離すと中断」に変化することを確認
   4. 離すと録音がキャンセルされることを確認
   ```

4. **録音モード切替**
   ```
   1. 翻訳結果画面で「録音モード」を確認
   2. 「長押し」「トグル」を切り替え
   3. 長押し: 押下中のみ録音
   4. トグル: タップで開始、再タップで停止
   5. リロード後も設定が保持されることを確認
   ```

5. **アニメーション**
   ```
   1. 履歴ボタンをクリック
   2. パネルがなめらかにスライドインすることを確認
   3. 閉じるボタンまたはEscで閉じる
   4. パネルがなめらかにスライドアウトすることを確認
   ```

Vercelへのデプロイも可能です！

