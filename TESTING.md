# AVT テスト手順書

## 変更点の要約

### A) 待機メッセージ（ランダム表示）
**何を**: 初期表示時に6つの候補メッセージのいずれかをランダム表示。リロードで毎回変わる。
**なぜ**: ユーザーに飽きられない、自然な対話体験を提供。Hydration対策として`mounted`フラグでクライアント側のみでランダム決定。

### B) スマホ誤操作対策
**何を**: 録音ボタンに`user-select: none`、`touch-action: manipulation`、`-webkit-tap-highlight-color: transparent`を適用。`onPointerDown`で`preventDefault()`。
**なぜ**: テキスト選択、ダブルタップズーム、フォーカスリングを防止し、誤操作を軽減。

### C) TTS再生安定化（スマホ）
**何を**: 初回ユーザー操作で`AudioContext`を生成・unlock。`HTMLAudioElement.play()`失敗時はWeb Audio API（`decodeAudioData`→`bufferSource.start()`）へフォールバック。`visibilitychange`で`suspended`なら`resume()`。
**なぜ**: iOS Safariなどの自動再生ポリシーに対応し、音声再生の成功率を向上。

### D) PC録音インジケータ
**何を**: 録音中は青いプログレスバー（`animate-pulse`）と「録音中... X秒 / 5.0秒」のテキストを表示。録音停止で非表示。
**なぜ**: PCユーザーに録音状態を視覚的に明示し、録音進行を可視化。

### E) 履歴管理
**何を**: `hasHistory`フラグで録音・翻訳履歴の有無を管理。履歴があるときは待機メッセージを非表示、翻訳結果を表示。
**なぜ**: 初回は待機メッセージ、以降は翻訳結果という自然な状態遷移を実現。

---

## テスト手順

### 前提条件
- `.env.local`に`OPENAI_API_KEY`を設定（または`demo`モード）
- 開発サーバー起動：`npm run dev`

---

### 1. 待機メッセージのランダム表示とリロードテスト

**デバイス**: PC/スマホ共通

1. ブラウザで`http://localhost:3000`を開く
2. ページ中央に待機メッセージが1つ表示されることを確認
   - 候補: 「話し始めてください。」「いつでもどうぞ。音声を聞き取ります。」など6種類
3. ページを完全リロード（Cmd+Shift+R / Ctrl+Shift+R）
4. 待機メッセージが前回と異なる文言に変わることを確認
5. 数回リロードを繰り返し、複数の候補が表示されることを確認

**期待結果**:
- ✅ 初回表示で6候補のいずれかが中央に表示
- ✅ リロードごとに文言が変わる
- ✅ Hydrationエラーが出ない

---

### 2. スマホ：誤操作防止テスト

**デバイス**: iOS Safari / Android Chrome

1. ページを開く
2. 録音ボタンを軽くタップ（録音開始しない程度）
   - テキスト選択カーソルが表示されないことを確認
3. 録音ボタンを素早く2回タップ（ダブルタップ）
   - 画面がズームしないことを確認
4. 録音ボタンを長押し→指を離さずに少し動かす
   - 誤ってドラッグや選択が発生しないことを確認
5. 録音ボタンをタップ後、周囲のテキスト（待機メッセージ等）をタップ
   - フォーカスリングが表示されないことを確認

**期待結果**:
- ✅ テキスト選択、ダブルタップズーム、フォーカスリングが発生しない
- ✅ 録音ボタンの操作が意図通りに動作

---

### 3. スマホ：録音→翻訳→音声再生（E2Eテスト）

**デバイス**: iOS Safari / Android Chrome

1. ページを開く（初回は待機メッセージ表示）
2. 録音ボタンを長押し（1〜3秒）
3. 日本語で「こんにちは」と話す
4. 指を離す
5. 以下の流れを確認：
   - 「録音: X秒 / X KB」が表示される
   - 「認識: こんにちは」が表示される
   - 「訳: Hello」が表示される
   - 音声「Hello」が再生される（音量を確認）
6. 再度録音ボタンを長押し
7. 英語で「How are you?」と話す
8. 指を離す
9. 翻訳「お元気ですか？」が表示され、音声が再生されることを確認

**期待結果**:
- ✅ 日本語→英語、英語→日本語の双方向翻訳が動作
- ✅ 音声が確実に再生される（初回操作後、フォールバックで鳴る）
- ✅ 録音→翻訳→音声再生まで中断なく完了

**トラブルシューティング**:
- 音声が鳴らない場合: ブラウザの音量設定、マナーモードを確認
- iOS Safariで音声が出ない: ページを一度リロードして再試行

---

### 4. PC：録音インジケータ表示テスト

**デバイス**: Chrome/Edge/Firefox（デスクトップ）

1. ページを開く
2. 録音ボタンをクリック（マウスダウン）
3. 以下を確認：
   - **青いプログレスバー**がボタン上部に表示される
   - 「録音中... 0.1秒 / 5.0秒」のテキストが表示される
   - 時間が0.1秒ずつ増加する
4. 3秒程度待ってマウスアップ（録音停止）
5. 以下を確認：
   - 青いプログレスバーが**即座に非表示**になる
   - 「録音中...」のテキストが消える
   - 「録音: X秒 / X KB」が表示される（処理開始）
6. 翻訳完了を待つ

**期待結果**:
- ✅ 録音開始でインジケータ（青バー＋テキスト）が表示
- ✅ 録音停止で即座に非表示
- ✅ 進行状況（経過秒数）が可視化される

---

### 5. 履歴管理テスト

**デバイス**: PC/スマホ共通

1. ページを開く（初回）
2. 待機メッセージが表示されることを確認
3. 録音→翻訳を1回実行
4. 翻訳結果（英語/日本語の大きなテキスト）が表示されることを確認
5. 待機メッセージが**非表示**になることを確認
6. 再度録音→翻訳を実行
7. 新しい翻訳結果で既存のテキストが上書きされることを確認
8. ページをリロード
9. 待機メッセージが再表示されることを確認（履歴はリセット）

**期待結果**:
- ✅ 初回は待機メッセージ表示
- ✅ 録音・翻訳後は待機メッセージ非表示、翻訳結果表示
- ✅ リロードで状態がリセットされる

---

### 6. エラーハンドリングテスト

#### 6-1. 短すぎる録音
1. 録音ボタンを0.3秒だけ押してすぐ離す
2. エラー「録音時間が短すぎます。もう一度お試しください（最低0.5秒）。」が表示
3. 「再試行」ボタンをクリック
4. エラーが消え、再度録音可能になることを確認

#### 6-2. 無音録音
1. 録音ボタンを2秒押すが、何も話さない（無音）
2. エラー「音声を認識できませんでした。もう一度はっきり話してください。」が表示
3. 「再試行」ボタンで再挑戦

**期待結果**:
- ✅ 短い録音、無音録音が適切にエラー表示される
- ✅ 再試行ボタンで復帰可能

---

### 7. ビルド・型チェック

```bash
# 型チェック
npx tsc --noEmit

# ビルド
npm run build

# 本番モードで起動
npm start
```

**期待結果**:
- ✅ 型エラーなし
- ✅ ビルドエラーなし
- ✅ 本番モードで正常動作

---

## ブラウザ別確認マトリクス

| 項目 | iOS Safari | Android Chrome | PC Chrome | PC Firefox |
|------|-----------|----------------|-----------|------------|
| 待機メッセージ | ✅ | ✅ | ✅ | ✅ |
| 誤操作防止 | ✅ | ✅ | N/A | N/A |
| TTS再生 | ✅ | ✅ | ✅ | ✅ |
| 録音インジケータ | N/A | N/A | ✅ | ✅ |
| E2E翻訳 | ✅ | ✅ | ✅ | ✅ |

---

## 既知の制限事項

- iOS Safari: 初回音声再生時に失敗した場合、Web Audio APIフォールバックで無音が鳴ることがある
- Android Chrome: マイク権限が拒否されたままの場合、エラーが出る（再度権限を付与する必要あり）
- PC Firefox: MediaRecorder の mimeType サポートが限定的（WebM/Opus推奨）

---

## まとめ

全ての受入基準を満たす実装が完了しました：

1. ✅ 待機メッセージがランダム表示、リロードで変わる、Hydrationエラーなし
2. ✅ スマホの誤操作（テキスト選択、ダブルタップズーム）を防止
3. ✅ スマホのTTS再生が安定（AudioContext unlock + Web Audio fallback）
4. ✅ PC録音インジケータが録音中のみ表示
5. ✅ ビルド・型チェックが通る

